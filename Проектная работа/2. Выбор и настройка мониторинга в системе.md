# Мотивация

Добавление системы наблюдаемости (observability) в текущую систему — это следующий шаг в повышении прозрачности работы системы и обеспечения её надежности. 
Наблюдаемость позволяет не только фиксировать сбои и проблемы, но и глубже анализировать их причины, а также понимать поведение системы в реальном времени. 
Концепция Observability включает в себя:
- мониторинг - сбор бизнесовых и инфраструктурных метрик (metrics).
- Логирование — сбор логов (logs).
- Трейсинг — сбор трейсов внутренних вызовов (traces).
Это всё критически важно как для бизнеса, так и для разработчиков.

**Для бизнеса:**
 - **Минимизация простоев**: системы мониторинга позволяют оперативно выявлять и устранять проблемы еще до того, 
    как они станут критичными и приведут к простою или потерям данных. Это снижает риски финансовых потерь, связанных с недоступностью сервисов.
 - **Повышение качества обслуживания**: мониторинг помогает следить за показателями производительности и качества работы системы, что напрямую влияет на пользовательский опыт. 
   Более стабильная и быстрая система ведет к лучшему удовлетворению потребителей, что положительно отражается на репутации компании
 - **Оптимизация ресурсов**: с помощью мониторинга можно выявлять избыточное или неэффективное использование ресурсов (серверов, памяти, сетей), 
   что позволяет оптимизировать расходы на инфраструктуру.
 - **Принятие обоснованных решений**: данные мониторинга могут быть использованы для анализа и принятия стратегических решений о развитии системы и оптимизации бизнес-процессов.

**Для разработчиков:**
- **Раннее обнаружение ошибок**: мониторинг помогает разработчикам выявлять и устранять ошибки на ранней стадии их появления. 
   Это снижает затраты на исправление проблем, так как многие из них могут быть устранены до того, как затронут конечных пользователей
- **Повышение производительности системы**: системы мониторинга предоставляют данные о нагрузке и производительности компонентов, 
   что позволяет разработчикам оптимизировать код и улучшать инфраструктуру, добиваясь более эффективной работы приложений
- **Быстрое реагирование на инциденты**: автоматические оповещения и метрики позволяют командам поддержки и разработки мгновенно получать информацию о возникших проблемах, 
   что ускоряет процесс их решения и снижает время отклика
- **Точное планирование масштабирования**: системы мониторинга предоставляют информацию о текущей и прогнозируемой нагрузке, 
   что помогает разработчикам и архитекторам правильно планировать масштабирование системы без переплат за избыточные мощности.

# Выбор подхода к мониторингу

Для каждой компоненты системы можно выбрать наиболее подходящую методику мониторинга в зависимости от её задач и архитектуры. 
Рассмотрим компоненты и предложим метрики, которые стоит собирать.
Для backend компонент, таких как базы данных, RabbitMQ будем использовать подход USE, который основан на мониторинге производительности.
Для API компонент будем использовать Four Golden Signals, как подход, который даст нам наибольшее представление о быстродействии отдельных эндпойнтов и пропускной способности компонента.

Также, в зависимости от модели развертывания, на каждом физическом или виртуальном хосте, используемом в системе необходимо собирать метрики утилизации системных ресурсов (CPU, memory, i/o), 
даже если они ниже не обозначены явно.


**Internet Shop (Web-приложение)**  
Методика: Four Golden Signals  
Почему: Веб-приложение взаимодействует с конечными пользователями, и важно следить за временем отклика, стабильностью и уровнем нагрузки для обеспечения качественного пользовательского опыта.
Метрики:
* Latency: Время ответа на запросы.
* Traffic: Количество запросов (входящих и исходящих).
* Errors: Количество HTTP ошибок (4xx, 5xx).
* Saturation: Нагрузка на серверы (использование ресурсов CPU, памяти).

**CRM (Система учета заказов и клиентов)**  
Методика: RED  
Почему: CRM является backend-системой, которая должна быть стабильной и обеспечивать обработку запросов без задержек.
Метрики:
* Rate: Количество запросов к CRM в секунду.
* Errors: Количество ошибок при выполнении операций (ошибки базы данных, бизнес-ошибки).
* Duration: Время выполнения запросов (длительность обработки операций).

**CRM API**  
Методика: Four Golden Signals  
Почему: CRM API интегрируется с другими системами, и важно следить за производительностью, устойчивостью к нагрузке и возможными ошибками при обработке запросов.
Метрики:
* Latency: Время обработки API-запросов.
* Traffic: Количество запросов к API.
* Errors: Количество ошибок (HTTP 4xx и 5xx, сбои запросов).
* Saturation: Нагрузка на систему, например, лимиты соединений или использование ресурсов.

**MES (Система расчета стоимости)**  
Методика: USE  
Почему: MES — вычислительная система, и важно контролировать её использование ресурсов, чтобы предотвратить перегрузки и поддерживать стабильную работу.
Метрики:
* Utilization: Загрузка CPU и памяти (интенсивность использования ресурсов).
* Saturation: Количество задач, ожидающих обработки.
* Errors: Количество ошибок при выполнении расчётов.

**MES API**  
Методика: Four Golden Signals  
Почему: MES API интегрируется с другими системами, и, как и в случае с CRM API, необходимо отслеживать его производительность и устойчивость к нагрузке.
Метрики:
* Latency: Время ответа на API-запросы.
* Traffic: Количество запросов к API.
* Errors: Количество ошибок (HTTP 4xx и 5xx).
* Saturation: Нагрузка на систему, например, лимиты соединений или использование ресурсов.

**RabbitMQ (Брокер сообщений)**  
Методика: USE  
Почему: RabbitMQ должен быть надежным и управляемым при высокой нагрузке. Важно контролировать использование ресурсов и предотвращать перегрузки в обработке сообщений.
Метрики:
* Utilization: Использование CPU, памяти и дисковых ресурсов.
* Saturation: Количество сообщений в очередях, которые ожидают обработки.
* Errors: Ошибки при доставке сообщений, отказ в подключении к брокеру.

**Shop Database (База данных магазина и CRM)**  
Методика: USE  
Почему: База данных критична для работы CRM и интернет-магазина. Важно следить за её производительностью и устойчивостью.
Метрики:
* Utilization: Использование CPU, дисковых операций (I/O).
* Saturation: Время выполнения запросов, количество ожидающих транзакций.
* Errors: Ошибки при выполнении запросов (отказы транзакций, блокировки).

**MES Database**  
Методика: USE  
Почему: Как и в случае с базой данных магазина, нужно следить за производительностью и надежностью базы данных, поддерживающей расчеты MES.
Метрики:
* Utilization: Загрузка CPU и дисковых операций (I/O).
* Saturation: Время выполнения запросов, количество ожидающих транзакций.
* Errors: Ошибки при выполнении запросов (отказы транзакций, блокировки).

**S3 хранилище (Файлы 3D моделей)**  
Методика: RED  
Почему: Для S3 важна доступность и скорость доступа к данным, но также необходимо отслеживать ошибки при загрузке и выгрузке файлов.
Метрики:
* Rate: Количество операций загрузки/выгрузки файлов.
* Errors: Ошибки при доступе к файлам.
* Duration: Время отклика на запросы доступа к файлам.

# План действий

Для реализации полной observability (включающей мониторинг, сбор логов и трейсинг) необходимо развернуть и настроить несколько ключевых компонентов, 
которые обеспечат комплексное наблюдение за всеми аспектами системы. 
Ниже приведен высокоуровневый план по развёртыванию нужных компонентов с использованием популярных и стандартных инструментов

**Мониторинг** включает сбор метрик для анализа производительности системы, её компонентов и ресурсов.  
Инструменты:
* Prometheus — для сбора метрик с различных компонентов.
* Grafana — для визуализации метрик и создания дашбордов.

1. Установка Prometheus
   - Развернуть Prometheus агенты для сбора метрик с компонентов системы (например, RabbitMQ, баз данных, веб-приложений).
   - При возможности использовать экспортёры (экспортеры для RabbitMQ, баз данных, и других сервисов)
2. Интеграция с сервисами
   - Настроить микросервисы и API-сервисы для экспорта метрик в Prometheus (например, через библиотеки Micrometer для SpringBoot).
   - Добавить метрики приложений на основе выбранной методики (Four Golden Signals, RED, USE).
3. Визуализация в Grafana
   - Настроить Grafana для подключения к Prometheus
   - Создать дашборды для мониторинга состояния системы в реальном времени
   - Включить алертинг на важные метрики (например, превышение задержек, ошибки).
   - Настроить правила для создания алертов по важным метрикам (ошибки, задержки, превышение лимитов ресурсов)

**Логирование** обеспечивает сбор и централизованное хранение логов для дальнейшего анализа и устранения неполадок.  
Инструменты:  
ELK Stack (Elasticsearch, Logstash/Fluentd, Kibana)
* Fluentd или Logstash — для сбора и передачи логов.
* Elasticsearch — для хранения и индексации логов.
* Kibana — для визуализации и анализа логов.

1. Настройка Fluentd или Logstash
    - Развернуть Fluentd или Logstash на серверах для сбора логов приложений, системных логов, логов API-сервисов и баз данных
    - Настроить отправку логов в Elasticsearch.
2. Настройка логгирования в микросервисах
    - Обновить микросервисы для отправки логов в формате JSON либо использовать доступные библиотеки для реализации этой функциональности.
    - Включить структуру логирования, которая включает важную информацию: ID запроса, метки пользователей, и метки сервисов
3. Визуализация в Kibana
    - Настроить Kibana для анализа и поиска по логам в Elasticsearch.
    - Создать дашборды для мониторинга логов и поиска по ним для быстрого устранения проблем

**Трейсинг** даёт представление о пути запросов через распределённые системы и помогает выявить узкие места и точки задержек.  
Инструменты:  
* Jaeger или Zipkin — для распределенного трейсинга.  
* OpenTelemetry — для сбора и передачи трейсов  
* Grafana Loki или Sentry - для корркляции логов с метриками.  

1. Развертывание Jaeger/Zipkin
    - Развернуть Jaeger (или Zipkin) для централизованного сбора трейсов.
2. Интеграция OpenTelemetry
    - Добавить OpenTelemetry в микросервисы, веб-приложение и API, чтобы передавать информацию о трейсах в Jaeger
    - Внедрить трейсы для всех HTTP-запросов, сообщений RabbitMQ, операций с базами данных и S3
    - Включить корреляцию трейсов с метриками и логами (например, через TraceId/SpanId)
3. Визуализация трейсов
    - Настроить Jaeger для отображения полного пути запросов через распределённые сервисы
    - Сконфигурировать Sentry или Grafana Loki для отображения нужной информации.

